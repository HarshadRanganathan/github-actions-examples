name: 'Policy Check: Managed Scaling'

on:
  pull_request:
    paths:
      - '**.tpl'

defaults:
  run:
    shell: bash

permissions:
  id-token: write
  contents: read 
  pull-requests: write

jobs:
  pr_checks:
    name: 'PR Checks'
        
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        
      - name: Get Changed Files
        id: changed-files
        uses: tj-actions/changed-files@v29.0.7

      - name: Validate Policy
        id: validate-policy 
        run: |
          {
            echo "|Result |File |Reason |" 
            echo "|--- |--- |--- |" 
          } >> "$GITHUB_STEP_SUMMARY"
          echo "result=pass" >> "$GITHUB_OUTPUT"
          
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if [ "${file: -4}" == ".tpl" ]; then
              if ! grep -q ManagedScalingPolicy "$file"; then
                echo "|👎 |$file | No Managed Scaling defined in template|" >> $GITHUB_STEP_SUMMARY
                echo "result=fail" >> "$GITHUB_OUTPUT"
              else
                echo "|👍  |$file | Managed Scaling defined in template|" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please refer our guide on how to add Managed Scaling to your templates: " >> $GITHUB_STEP_SUMMARY
          
          echo "summary<<EOF"  >> $GITHUB_ENV
          cat $GITHUB_STEP_SUMMARY >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
      - name: Update Pull Request
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: process.env.summary
            })
      
      - name: Result
        if: steps.validate-policy.outputs.result != 'pass'
        run: exit 1
      
